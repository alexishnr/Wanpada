'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _regenerator;

function _load_regenerator() {
  return _regenerator = _interopRequireDefault(require('babel-runtime/regenerator'));
}

var _slicedToArray2;

function _load_slicedToArray() {
  return _slicedToArray2 = _interopRequireDefault(require('babel-runtime/helpers/slicedToArray'));
}

var _asyncToGenerator2;

function _load_asyncToGenerator() {
  return _asyncToGenerator2 = _interopRequireDefault(require('babel-runtime/helpers/asyncToGenerator'));
}

var checkForUpdateAsync = function () {
  var _ref4 = (0, (_asyncToGenerator2 || _load_asyncToGenerator()).default)( /*#__PURE__*/(_regenerator || _load_regenerator()).default.mark(function _callee2() {
    var current, _ref5, latest, state;

    return (_regenerator || _load_regenerator()).default.wrap(function _callee2$(_context2) {
      while (1) {
        switch (_context2.prev = _context2.next) {
          case 0:
            current = (_package || _load_package()).default.version;

            // check for an outdated install based on either a fresh npm query or our cache

            _context2.next = 3;
            return UpdateCacher.getAsync();

          case 3:
            _ref5 = _context2.sent;
            latest = _ref5.latestVersion;
            state = void 0;
            _context2.t0 = (_semver || _load_semver()).default.compare(current, latest);
            _context2.next = _context2.t0 === -1 ? 9 : _context2.t0 === 0 ? 11 : _context2.t0 === 1 ? 13 : 15;
            break;

          case 9:
            state = 'out-of-date';
            return _context2.abrupt('break', 16);

          case 11:
            state = 'up-to-date';
            return _context2.abrupt('break', 16);

          case 13:
            state = 'ahead-of-published';
            return _context2.abrupt('break', 16);

          case 15:
            throw new Error('Confused about whether CLI is up-to-date or not');

          case 16:
            return _context2.abrupt('return', {
              state: state,
              current: current,
              latest: latest
            });

          case 17:
          case 'end':
            return _context2.stop();
        }
      }
    }, _callee2, this);
  }));

  return function checkForUpdateAsync() {
    return _ref4.apply(this, arguments);
  };
}();

var _child_process;

function _load_child_process() {
  return _child_process = _interopRequireDefault(require('mz/child_process'));
}

var _jsonFile;

function _load_jsonFile() {
  return _jsonFile = _interopRequireDefault(require('@expo/json-file'));
}

var _path = _interopRequireDefault(require('path'));

var _semver;

function _load_semver() {
  return _semver = _interopRequireDefault(require('semver'));
}

var _xdl;

function _load_xdl() {
  return _xdl = require('xdl');
}

var _package;

function _load_package() {
  return _package = _interopRequireDefault(require('../package.json'));
}

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var UpdateCacher = new (_xdl || _load_xdl()).FsCache.Cacher((0, (_asyncToGenerator2 || _load_asyncToGenerator()).default)( /*#__PURE__*/(_regenerator || _load_regenerator()).default.mark(function _callee() {
  var _ref2, _ref3, version, _;

  return (_regenerator || _load_regenerator()).default.wrap(function _callee$(_context) {
    while (1) {
      switch (_context.prev = _context.next) {
        case 0:
          _context.next = 2;
          return (_child_process || _load_child_process()).default.exec('npm view ' + (_package || _load_package()).default.name + ' version');

        case 2:
          _ref2 = _context.sent;
          _ref3 = (0, (_slicedToArray2 || _load_slicedToArray()).default)(_ref2, 2);
          version = _ref3[0];
          _ = _ref3[1];
          return _context.abrupt('return', {
            latestVersion: version.trim()
          });

        case 7:
        case 'end':
          return _context.stop();
      }
    }
  }, _callee, undefined);
})), (_package || _load_package()).default.name + '-updates.json', 24 * 60 * 60 * 1000 // one day
);

exports.default = {
  checkForUpdateAsync: checkForUpdateAsync
};
module.exports = exports['default'];
//# sourceMappingURL=__sourcemaps__/update.js.map
